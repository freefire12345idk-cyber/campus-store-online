generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String   @unique
  password  String
  role      String   // "student" | "shop_owner" | "admin"
  name      String?
  isAdmin   Boolean  @default(false)
  isBanned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student   Student?
  shopOwner ShopOwner?
  reports   Report[]
  messagesSent     Message[] @relation("MessageSender")
  messagesReceived Message[] @relation("MessageReceiver")
}

model Student {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  collegeId    String
  college      College  @relation(fields: [collegeId], references: [id])
  section      String
  hostelBranch String
  rollNo       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders  Order[]
  reports Report[]
}

model College {
  id        String   @id @default(cuid())
  name      String
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())

  students     Student[]
  shopColleges ShopCollege[]
  orders       Order[]
}

model ShopOwner {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shopId    String?  @unique
  shop      Shop?    @relation(fields: [shopId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Shop {
  id           String   @id @default(cuid())
  name         String
  latitude     Float
  longitude    Float
  address      String?
  phone        String?
  shopPhoto    String?  // required in UI at registration
  paymentQrUrl String?  // required in UI at registration - QR for payment
  isApproved   Boolean  @default(false)
  isBanned     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  owner        ShopOwner?
  shopColleges ShopCollege[]
  products     Product[]
  orders       Order[]
  reports      Report[]
}

model ShopCollege {
  id        String   @id @default(cuid())
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  collegeId String
  college   College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([shopId, collegeId])
}

model Product {
  id          String   @id @default(cuid())
  shopId      String
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  name        String
  price       Float
  imageUrl    String?
  description String?
  isBanned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems OrderItem[]
  reports    Report[]
}

model Order {
  id              String   @id @default(cuid())
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  shopId          String
  shop            Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  collegeId       String
  college         College  @relation(fields: [collegeId], references: [id])
  totalAmount     Float
  status          String
  paymentProofUrl String?
  deliveryOtp     String?
  hostelBranch    String?
  rollNo          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  items         OrderItem[]
  notifications Notification[]
  reports       Report[]
  messages      Message[]
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int
  price     Float
}

model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

model Notification {
  id        String   @id @default(cuid())
  orderId   String?
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  userId    String
  title     String
  body      String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Report {
  id            String   @id @default(cuid())
  type          String
  description   String
  attachmentUrl String?
  status        String   @default("open")
  reporterId    String
  reporter      User     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  shopId        String?
  shop          Shop?    @relation(fields: [shopId], references: [id], onDelete: SetNull)
  studentId     String?
  student       Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
  productId     String?
  product       Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  orderId       String?
  order         Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  orderId    String?
  content    String
  createdAt  DateTime @default(now())

  sender   User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  order    Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)
}

model SupportContact {
  id        String   @id @default(cuid())
  name      String
  whatsapp  String?
  telegram  String?
  email     String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
